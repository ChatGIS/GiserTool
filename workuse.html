<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>demo测试</title>
		<!-- CDN -->
		<script src="http://cdn.staticfile.org/jquery/2.0.0/jquery.min.js"></script>
		<!-- <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
		<link href="https://openlayers.org/en/v4.6.5/css/ol.css" rel="stylesheet" type="text/css"> -->
		
		<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css">

		<!-- 本地资源 -->
		<!-- <link href="../js/openLayersv4.1.1/ol.css" rel="stylesheet" type="text/css"/>
		<script src="../js/openLayersv4.1.1/ol.js" type="text/javascript" charset="UTF-8"></script>
		<script src="../js/jquerymin.js" type="text/javascript" charset="UTF-8"></script>-->
	</head>
	<body>
		<div style="width: 100;height: 30px;">
			<span>缩放级别：</span><input type="text" id="zoom_level"/>
		</div>
		<div id="map" style="width: 100%;height: 500px;"></div>
		<div style="width: 100;height: 30px;">
			<span>点击查询结果：</span><input type="text" id="message"/>
			<button id="feature" onclick="onMap()">上图</button>
		</div>
		
		<script>
			// 高德底图
			var gaodeTileLayer = new ol.layer.Tile({
				source: new ol.source.XYZ({
					url:'http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&style=7&x={x}&y={y}&z={z}'
				})
			});
			
			// 地图
			var map = new ol.Map({
				layers:[gaodeTileLayer],
				view: new ol.View({
					center: [117.020847,36.670086],
					maxZoom: 19,
					zoom: 4,
					projection: 'EPSG:4326'
				}),
				target: 'map'
			})
			
			var source = new ol.source.Vector();
			
			// 初始化控件
			AddScaleLint();
			
			// 根据GeoJSON定义图层
			function getGeoJSON(src){
				source.addFeatures(new ol.format.GeoJSON().readFeatures(src));
				var layerProvince = new ol.layer.Vector({
					source: source
				});
				map.addLayer(layerProvince);
			}			
			 
			// ajax获取数据
			// $.ajax({
			// 	url: 'http://localhost:8082/geoserver/DreamiceWS/ows?'+
			// 		'service=WFS&version=1.0.0&request=GetFeature&typeName=DreamiceWS%3Agadm36_CHN_1&'+
			// 		'maxFeatures=5000&outputFormat=application%2Fjson',
			// 	success: function(data, status){
			// 		getGeoJSON(data);
			// 	}
			// })
			
			// 单击事件
			map.on('singleclick', function(e){
				// 通过source/vector的getFeaturesAtCoordinate(coordinate)方法
				/* var features = source.getFeaturesAtCoordinate(e.coordinate);
				if(features.length > 0){
					console.log(features[0].getProperties().NAME_0);
					console.log(features[0].getProperties().NAME_1);
				} */
				var pixel = map.getEventPixel(e.originalEvent);
				// 通过map的getFeaturesAtPixel(pixel)方法
				var features = map.getFeaturesAtPixel(pixel);
				if(features != null && features.length > 0){
					console.log(features[0].getProperties().NAME_0);
					console.log(features[0].getProperties().NAME_1);
					$("#message").val(features[0].getProperties().NAME_0 + ":" + features[0].getProperties().NAME_1);
				}
			})
			
			// 地图滑动
			map.on("moveend",function(e){
			    getZoomShow();
			}); 
			
			// select交互
			/* var selectSingleClick = new ol.interaction.Select();
			map.addInteraction(selectSingleClick);
			selectSingleClick.on('select', function(e){
				if(e.selected.length > 0){
					console.log(e.selected[0].getProperties().NAME_0);
					console.log(e.selected[0].getProperties().NAME_1);
				}
			}); */
			
			/**
			 * 获取返回数据
			 */
			function getDataSourceByArcgis(str) {
				var format = new ol.format.EsriJSON();
				var fr = format.readFeatures(str, {
					featureProjection: "EPSG:4326"
				});
				return fr;
			};
			
			// 上图
			function onMap(){
				var source = new ol.source.Vector({
				    wrapX: false
				});
				var layer = new ol.layer.Vector({
				    source: source,
				    //zIndex : zIndex
				});
				map.addLayer(layer);
				
				debugger;
				var params = [{"commCode":"TY_588","commRank":"1","centerLonlat":"112.731,37.6642"},{"commCode":"TY_589","commRank":"2","centerLonlat":"112.732,37.6644"}];
				// app.map.moveToDirect(params[0].centerLonlat,10);
				//app.featureModifyLayer.source.clear();
				moveToDirect(params[0].centerLonlat,16);
				source.clear();
				for (var i = 0; i < params.length; i++) {
					var lonlat = params[i].centerLonlat.split(",");
					var feature = new ol.Feature({
						geometry: new ol.geom.Point(lonlat)
					});
					feature.set("commCode", params[i].commCode);
					feature.set("centerLonlat", params[i].centerLonlat);
					feature.set("commRank", params[i].commRank);
					feature.set("featureIndex", String(i + 1));
					var style = new ol.style.Style({
						image: new ol.style.Icon({
							anchor: [15, 30],
							anchorXUnits: "pixels",
							anchorYUnits: "pixels",
							opacity: 1,
							src: "resource/image/location_comm.png"
						}),
						// image: new ol.style.Circle({
						//   radius: 5,
						//   fill: new ol.style.Fill({
						// 	color: "orange"
						//   })
						// }),
						text: new ol.style.Text({
							text: feature.get("commRank") || feature.get("commRank") || "",
							font: "12px bold",
							fill: new ol.style.Fill({
								color: "#FFFFFF"
							}),
							offsetX: 0,
							offsetY: -16
						})
					});
					feature.setStyle(style);
					//app.featureModifyLayer.source.addFeature(feature);
					source.addFeature(feature);
				}
				getZoomShow();
			}	
			
			// 视图定位
			function moveToDirect(coordinate, zoom){
				if((typeof coordinate) == "string"){
					coordinate = coordinate.split(",");
				}
				if (zoom != undefined) map.getView().setZoom(zoom);
				var lon = parseFloat(coordinate[0]);
				var lat = parseFloat(coordinate[1]);
			    var arr = [lon,lat];
			    map.getView().setCenter(arr);
			}
			
			// 获取缩放级别并展示
			function getZoomShow(){
				var zoom = map.getView().getZoom();
				$("#zoom_level").val(zoom);
			}
			
			//添加比例尺
			// 发现，4.6.5的版本比例尺数值不正确
			function AddScaleLint() {
				var scaleLineControl = new ol.control.ScaleLine({
					Units: 'metric',//单位有5种：degrees imperial us nautical metric
				});
				map.addControl(scaleLineControl);
			}

		</script>
	</body>
</html>
