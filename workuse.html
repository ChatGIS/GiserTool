<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>demo测试</title>
		<!-- CDN -->
		<script src="http://cdn.staticfile.org/jquery/2.0.0/jquery.min.js"></script>
		<!-- <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
		<link href="https://openlayers.org/en/v4.6.5/css/ol.css" rel="stylesheet" type="text/css"> -->
		
		<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css">

		<!-- 本地资源 -->
		<!-- <link href="../js/openLayersv4.1.1/ol.css" rel="stylesheet" type="text/css"/>
		<script src="../js/openLayersv4.1.1/ol.js" type="text/javascript" charset="UTF-8"></script>
		<script src="../js/jquerymin.js" type="text/javascript" charset="UTF-8"></script>-->
	</head>
	<body>
		<div style="width: 100;height: 30px;">
			<span>缩放级别：</span><input type="text" id="zoom_level"/>
		</div>
		<div id="map" style="width: 100%;height: 500px;"></div>
		<div style="width: 100;height: 30px;">
			<span>点击查询结果：</span><input type="text" id="message"/>
			<button id="feature" onclick="onMap()">上图</button>
		</div>
		
		<script>
			// 高德底图
			var gaodeTileLayer = new ol.layer.Tile({
				source: new ol.source.XYZ({
					url:'http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&style=7&x={x}&y={y}&z={z}'
				})
			});
			
			var testCenter = [117.80652,34.516879];
			var data1 = {"type":"FeatureCollection","totalFeatures":1,"features":[{"type":"Feature","id":"CITY_SD.1","geometry":{"type":"Polygon","coordinates":[[[117.375012,35.312735],[117.361219,35.314281],[117.354399,35.317933],[117.341986,35.315101],[117.321081,35.320061],[117.311496,35.32011],[117.309216,35.315937],[117.302034,35.311167],[117.303999,35.304804],[117.309513,35.3004],[117.308409,35.289366],[117.305489,35.285984],[117.303324,35.289192],[117.294224,35.29443],[117.27743,35.296641],[117.274703,35.296661],[117.273274,35.291084],[117.266558,35.287398],[117.261037,35.287494],[117.254784,35.289886],[117.251158,35.288389],[117.257231,35.270527],[117.258063,35.260529],[117.256059,35.257778],[117.251085,35.257291],[117.227919,35.261391],[117.213306,35.259583],[117.202311,35.260515],[117.197412,35.256707],[117.193251,35.247821],[117.188772,35.245713],[117.170806,35.243486],[117.146835,35.232306],[117.120611,35.23143],[117.109021,35.228847],[117.102935,35.226113],[117.096782,35.220747],[117.087015,35.220623],[117.073282,35.226049],[117.06159,35.228384],[117.045636,35.224118],[117.023069,35.221599],[117.008987,35.215261],[117.000803,35.203413],[116.963314,35.187485],[116.963207,35.183358],[116.959118,35.179179],[116.950055,35.178321],[116.933042,35.171014],[116.927192,35.173107],[116.922065,35.180516],[116.91405,35.180829],[116.908024,35.178168],[116.898176,35.17712],[116.892646,35.196251],[116.883483,35.193392],[116.870681,35.186643],[116.863486,35.175492],[116.853571,35.165443],[116.849329,35.166552],[116.844568,35.173283],[116.828995,35.184383],[116.825297,35.184123],[116.814101,35.17919],[116.80586,35.17778],[116.810064,35.170792],[116.807655,35.159986],[116.812194,35.15108],[116.820732,35.147341],[116.824096,35.127088],[116.834681,35.115577],[116.847215,35.104109],[116.869859,35.088706],[116.875461,35.077307],[116.87707,35.076322],[116.88801,35.077514],[116.891916,35.074796],[116.896669,35.06887],[116.893639,35.065921],[116.893349,35.063312],[116.895829,35.058964],[116.895599,35.055994],[116.902147,35.044333],[116.918544,35.046359],[116.915149,35.030867],[116.922026,35.028428],[116.926757,35.023296],[116.938639,35.021596],[116.942739,35.01895],[116.949577,35.005458],[116.95613,35.000234],[116.950905,34.994295],[116.949634,34.989815],[116.941209,34.985687],[116.939847,34.975363],[116.949317,34.961927],[116.9575,34.961728],[116.959458,34.950757],[116.969283,34.951339],[116.97063,34.950009],[116.967022,34.941023],[116.97167,34.935619],[116.996492,34.941644],[117.001518,34.940134],[117.007127,34.943695],[117.015561,34.936947],[117.028039,34.94063],[117.040429,34.925274],[117.046117,34.927375],[117.06865,34.927246],[117.072954,34.932007],[117.107275,34.93151],[117.107662,34.911935],[117.109738,34.907953],[117.115267,34.90361],[117.121608,34.859503],[117.133308,34.854604],[117.135916,34.848041],[117.150662,34.834841],[117.162163,34.830711],[117.172085,34.829102],[117.175802,34.825386],[117.184035,34.823384],[117.178763,34.813995],[117.173349,34.812175],[117.157223,34.784417],[117.170047,34.783973],[117.185843,34.780565],[117.20161,34.769588],[117.20865,34.761947],[117.213823,34.751569],[117.219669,34.747269],[117.231898,34.741902],[117.239357,34.732097],[117.24791,34.728525],[117.251443,34.722394],[117.253352,34.722392],[117.260729,34.729053],[117.274646,34.727322],[117.278419,34.715781],[117.293012,34.720074],[117.298456,34.719896],[117.307617,34.717218],[117.313781,34.71268],[117.32013,34.702194],[117.319686,34.696901],[117.329645,34.693179],[117.327937,34.684866],[117.323332,34.677845],[117.328595,34.674268],[117.340505,34.671635],[117.350943,34.66228],[117.351486,34.659359],[117.34858,34.656946],[117.34838,34.65424],[117.36128,34.65085],[117.363329,34.647671],[117.364399,34.640925],[117.368594,34.636158],[117.370465,34.623012],[117.377595,34.625562],[117.378214,34.629205],[117.396852,34.628925],[117.402212,34.611234],[117.396671,34.610012],[117.392014,34.605025],[117.393019,34.589421],[117.387995,34.588367],[117.388246,34.58003],[117.386466,34.57562],[117.396301,34.570098],[117.397084,34.548024],[117.414097,34.539088],[117.420356,34.526453],[117.426826,34.521738],[117.433653,34.520973],[117.432457,34.517095],[117.439075,34.513297],[117.449056,34.503536],[117.455334,34.4945],[117.459267,34.485494],[117.47639,34.486675],[117.48093,34.483141],[117.481535,34.467136],[117.485322,34.467688],[117.488774,34.471722],[117.487504,34.473474],[117.495618,34.473745],[117.50721,34.473669],[117.510753,34.4716],[117.532729,34.46802],[117.542398,34.476297],[117.555973,34.472858],[117.564722,34.464],[117.570334,34.462786],[117.58666,34.463546],[117.599062,34.480129],[117.604,34.491546],[117.614602,34.492203],[117.618382,34.488369],[117.624156,34.489699],[117.628877,34.492858],[117.633109,34.498773],[117.636105,34.498513],[117.638725,34.494807],[117.641507,34.494096],[117.652506,34.500004],[117.655297,34.506549],[117.667591,34.516572],[117.676325,34.530569],[117.678995,34.548915],[117.698189,34.545944],[117.713869,34.545456],[117.759596,34.533556],[117.776186,34.525766],[117.783841,34.520033],[117.795491,34.520247],[117.792804,34.525181],[117.792789,34.535081],[117.789211,34.540038],[117.789714,34.544765],[117.788039,34.549137],[117.790979,34.55903],[117.787918,34.56118],[117.788924,34.567344],[117.786138,34.57493],[117.795737,34.620496],[117.787972,34.626612],[117.790212,34.638671],[117.789603,34.646315],[117.787289,34.649619],[117.788119,34.65269],[117.794294,34.651477],[117.793738,34.648208],[117.800011,34.647147],[117.813261,34.68276],[117.819843,34.685264],[117.82591,34.709563],[117.823628,34.712374],[117.818614,34.714478],[117.82111,34.722245],[117.817915,34.729639],[117.826317,34.747637],[117.825413,34.753884],[117.814316,34.763347],[117.793404,34.769734],[117.779012,34.780933],[117.777223,34.785065],[117.780301,34.791566],[117.780165,34.794497],[117.770386,34.79623],[117.768474,34.798188],[117.768779,34.801462],[117.770524,34.802943],[117.792823,34.811136],[117.794833,34.814079],[117.798161,34.8311],[117.796625,34.835615],[117.790388,34.836306],[117.75727,34.84937],[117.747333,34.857988],[117.738545,34.873028],[117.72376,34.877541],[117.709433,34.897018],[117.708294,34.901062],[117.698797,34.907571],[117.699394,34.914492],[117.694366,34.924704],[117.695038,34.928752],[117.698539,34.934216],[117.706557,34.935781],[117.709101,34.937752],[117.710362,34.941194],[117.70862,34.948216],[117.718934,34.959226],[117.713703,34.968696],[117.721228,34.980938],[117.720577,35.002771],[117.722411,35.008614],[117.73146,35.0128],[117.73784,35.018698],[117.738939,35.02102],[117.738086,35.02506],[117.733614,35.030526],[117.726399,35.027963],[117.713859,35.030785],[117.702695,35.027206],[117.696461,35.042532],[117.701628,35.048509],[117.700672,35.050489],[117.690081,35.055761],[117.687038,35.059243],[117.675333,35.059511],[117.661091,35.067881],[117.649097,35.077832],[117.646812,35.087179],[117.63635,35.09594],[117.628527,35.09826],[117.619713,35.111256],[117.614002,35.114404],[117.60109,35.132392],[117.593691,35.13692],[117.589345,35.145424],[117.588133,35.152346],[117.580457,35.153833],[117.577486,35.166311],[117.564825,35.168817],[117.556001,35.165425],[117.550519,35.161469],[117.542811,35.162162],[117.535182,35.168727],[117.527517,35.180294],[117.522225,35.184651],[117.521094,35.200962],[117.510017,35.198098],[117.500658,35.199593],[117.484523,35.210233],[117.482003,35.215885],[117.471598,35.225031],[117.463037,35.22861],[117.454702,35.227948],[117.442181,35.232],[117.440856,35.235083],[117.444596,35.241911],[117.443895,35.246848],[117.435953,35.253341],[117.433418,35.258927],[117.420432,35.261911],[117.413639,35.267728],[117.413152,35.273997],[117.409407,35.274449],[117.400421,35.282802],[117.397665,35.290041],[117.398163,35.299598],[117.395607,35.304829],[117.392911,35.306807],[117.380211,35.308794],[117.375012,35.312735]]]},"geometry_name":"GEOMETRY","properties":{"NAME":"枣庄市"}}],"crs":{"type":"name","properties":{"name":"urn:ogc:def:crs:EPSG::4326"}}}
			var geojsonObject = {
			  'type': 'FeatureCollection',
			  'crs': {
			    'type': 'name',
			    'properties': {
			      'name': 'EPSG:4326',
			    },
			  },
			  'features': [
			    {
			      'type': 'Feature',
			      'geometry': {
			        'type': 'Polygon',
			        'coordinates': [
					[
						[117.81551266134001,34.516879],[117.81533986987394,34.5151246188034],[117.81482813575484,34.51343765749231],[117.81399712463795,34.51188294504387],[117.81287877181444,34.51052022818557],[117.81151605495614,34.50940187536206],[117.80996134250769,34.508570864245165],[117.80827438119661,34.50805913012607],[117.80652,34.50788633866],[117.8047656188034,34.50805913012607],[117.80307865749232,34.508570864245165],[117.80152394504387,34.50940187536206],[117.80016122818557,34.51052022818557],[117.79904287536206,34.51188294504387],[117.79821186424518,34.51343765749231],[117.79770013012607,34.5151246188034],[117.79752733866,34.516879],[117.79770013012607,34.51863338119661],[117.79821186424518,34.520320342507695],[117.79904287536206,34.52187505495613],[117.80016122818557,34.523237771814436],[117.80152394504387,34.52435612463795],[117.80307865749232,34.52518713575484],[117.8047656188034,34.525698869873935],[117.80652,34.525871661340005],[117.80827438119661,34.525698869873935],[117.80996134250769,34.52518713575484],[117.81151605495614,34.52435612463795],[117.81287877181444,34.523237771814436],[117.81399712463795,34.52187505495613],[117.81482813575484,34.520320342507695],[117.81533986987394,34.51863338119661],[117.81551266134001,34.516879]
					],
					[
						[117.83819266134,34.498718],[117.83801986987393,34.49696361880339],[117.83750813575483,34.495276657492305],[117.83667712463794,34.493721945043866],[117.83555877181443,34.49235922818556],[117.83419605495614,34.49124087536205],[117.83264134250769,34.49040986424516],[117.8309543811966,34.489898130126065],[117.8292,34.489725338659994],[117.8274456188034,34.489898130126065],[117.82575865749232,34.49040986424516],[117.82420394504386,34.49124087536205],[117.82284122818557,34.49235922818556],[117.82172287536206,34.493721945043866],[117.82089186424517,34.495276657492305],[117.82038013012607,34.49696361880339],[117.82020733866,34.498718],[117.82038013012607,34.5004723811966],[117.82089186424517,34.50215934250769],[117.82172287536206,34.50371405495613],[117.82284122818557,34.50507677181443],[117.82420394504386,34.50619512463794],[117.82575865749232,34.507026135754835],[117.8274456188034,34.50753786987393],[117.8292,34.50771066134],[117.8309543811966,34.50753786987393],[117.83264134250769,34.507026135754835],[117.83419605495614,34.50619512463794],[117.83555877181443,34.50507677181443],[117.83667712463794,34.50371405495613],[117.83750813575483,34.50215934250769],[117.83801986987393,34.5004723811966],[117.83819266134,34.498718]
					],
					[
						[117.84237166134,34.456767],[117.84219886987393,34.455012618803394],[117.84168713575482,34.45332565749231],[117.84085612463794,34.45177094504387],[117.83973777181443,34.450408228185566],[117.83837505495613,34.449289875362055],[117.83682034250768,34.44845886424516],[117.8351333811966,34.44794713012607],[117.833379,34.44777433866],[117.83162461880339,34.44794713012607],[117.82993765749231,34.44845886424516],[117.82838294504386,34.449289875362055],[117.82702022818556,34.450408228185566],[117.82590187536205,34.45177094504387],[117.82507086424516,34.45332565749231],[117.82455913012606,34.455012618803394],[117.82438633865999,34.456767],[117.82455913012606,34.458521381196604],[117.82507086424516,34.46020834250769],[117.82590187536205,34.46176305495613],[117.82702022818556,34.46312577181443],[117.82838294504386,34.46424412463794],[117.82993765749231,34.46507513575484],[117.83162461880339,34.46558686987393],[117.833379,34.46575966134],[117.8351333811966,34.46558686987393],[117.83682034250768,34.46507513575484],[117.83837505495613,34.46424412463794],[117.83973777181443,34.46312577181443],[117.84085612463794,34.46176305495613],[117.84168713575482,34.46020834250769],[117.84219886987393,34.458521381196604],[117.84237166134,34.456767]
					],
					[
						[117.82572866134001,34.45413],[117.82555586987394,34.452375618803394],[117.82504413575484,34.45068865749231],[117.82421312463795,34.44913394504387],[117.82309477181444,34.447771228185566],[117.82173205495614,34.446652875362055],[117.82017734250769,34.44582186424516],[117.81849038119661,34.44531013012607],[117.816736,34.44513733866],[117.8149816188034,34.44531013012607],[117.81329465749232,34.44582186424516],[117.81173994504387,34.446652875362055],[117.81037722818557,34.447771228185566],[117.80925887536206,34.44913394504387],[117.80842786424517,34.45068865749231],[117.80791613012607,34.452375618803394],[117.80774333866,34.45413],[117.80791613012607,34.455884381196604],[117.80842786424517,34.45757134250769],[117.80925887536206,34.45912605495613],[117.81037722818557,34.46048877181443],[117.81173994504387,34.46160712463794],[117.81329465749232,34.46243813575484],[117.8149816188034,34.46294986987393],[117.816736,34.46312266134],[117.81849038119661,34.46294986987393],[117.82017734250769,34.46243813575484],[117.82173205495614,34.46160712463794],[117.82309477181444,34.46048877181443],[117.82421312463795,34.45912605495613],[117.82504413575484,34.45757134250769],[117.82555586987394,34.455884381196604],[117.82572866134001,34.45413]
					]
			      ]}
			    }]
				};
			var styleFeature = new ol.style.Style({
				stroke: new ol.style.Stroke({
				  color: 'blue',
				  width: 3,
				}),
				fill: new ol.style.Fill({
				  color: 'rgba(0, 0, 255, 0.1)',
				})
			});
			
			var styleRed = new ol.style.Style({
				stroke: new ol.style.Stroke({
				  color: 'red',
				  width: 3,
				}),
				fill: new ol.style.Fill({
				  color: 'rgba(0, 0, 255, 0.2)',
				})
			});
			
			var sourceFeature = new ol.source.Vector({
			  features: new ol.format.GeoJSON().readFeatures(geojsonObject),
			});
			
			var layerFeature = new ol.layer.Vector({
			  source: sourceFeature,
			  style: styleFeature,
			});
			
			var polygon = new ol.geom.Polygon([[[116.80586,34.4627860002],[116.80586,35.3201099999],[117.826317,35.3201099999], [117.826317,34.4627860002]]]);
			var feature = new ol.Feature(polygon);
			
			// 最小外接矩形
			var layerMBR = new ol.layer.Vector({
			  source: new ol.source.Vector({
				  features: [feature],
				}),
			  style: styleRed,
			});
			
			// 地图
			var map = new ol.Map({
				layers:[gaodeTileLayer, layerFeature, layerMBR],
				view: new ol.View({
					center: [117.020847,36.670086],
					maxZoom: 19,
					zoom: 4,
					projection: 'EPSG:4326'
				}),
				target: 'map'
			})
			
			var source = new ol.source.Vector();
			
			// 初始化控件
			AddScaleLint();
			
			// 根据GeoJSON定义图层
			function getGeoJSON(src){
				source.addFeatures(new ol.format.GeoJSON().readFeatures(src));
				var layerProvince = new ol.layer.Vector({
					source: source
				});
				map.addLayer(layerProvince);
			}			
			 
			// ajax获取数据
			$.ajax({
				/* url: 'http://119.188.255.2:18080/geoserver/zyks/ows?'+
					'service=WFS&version=1.0.0&request=GetFeature&typeName=zyks%3AT_ZYKS_CITY_SD&'+
					'maxFeatures=5000&outputFormat=application%2Fjson', */
				//url: 'http://119.188.255.2:18080/geoserver/irmscommon/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=irmscommon%3AT_SYS_REGION&maxFeatures=5000&outputFormat=application%2Fjson',
				// url: 'http://137.64.43.104:18080/geoserver/gis/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=gis%3AV_GRIDDING_MSG&maxFeatures=5000&outputFormat=application%2Fjson',
				url: 'http://172.18.193.221:18080/geoserver/irmscommon/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=irmscommon:CITY_SD&maxFeatures=50&outputFormat=application%2Fjson',
				success: function(data, status){
					getGeoJSON(data);
				},
				error : function(data, status){
					getGeoJSON(data1);
				}
			})
			
			// 单击事件
			map.on('singleclick', function(e){
				// 通过source/vector的getFeaturesAtCoordinate(coordinate)方法
				/* var features = source.getFeaturesAtCoordinate(e.coordinate);
				if(features.length > 0){
					console.log(features[0].getProperties().NAME_0);
					console.log(features[0].getProperties().NAME_1);
				} */
				var pixel = map.getEventPixel(e.originalEvent);
				// 通过map的getFeaturesAtPixel(pixel)方法
				var features = map.getFeaturesAtPixel(pixel);
				if(features != null && features.length > 0){
					console.log(features[0].getProperties().NAME_0);
					console.log(features[0].getProperties().NAME_1);
					$("#message").val(features[0].getProperties().NAME_0 + ":" + features[0].getProperties().NAME_1);
				}
			})
			
			// 地图滑动
			map.on("moveend",function(e){
			    getZoomShow();
			}); 
			
			// select交互
			/* var selectSingleClick = new ol.interaction.Select();
			map.addInteraction(selectSingleClick);
			selectSingleClick.on('select', function(e){
				if(e.selected.length > 0){
					console.log(e.selected[0].getProperties().NAME_0);
					console.log(e.selected[0].getProperties().NAME_1);
				}
			}); */
			
			/**
			 * 获取返回数据
			 */
			function getDataSourceByArcgis(str) {
				var format = new ol.format.EsriJSON();
				var fr = format.readFeatures(str, {
					featureProjection: "EPSG:4326"
				});
				return fr;
			};
			
			// 上图
			function onMap(){
				var source = new ol.source.Vector({
				    wrapX: false
				});
				var layer = new ol.layer.Vector({
				    source: source,
				    //zIndex : zIndex
				});
				map.addLayer(layer);
				
				debugger;
				var params = [{"commCode":"TY_588","commRank":"1","centerLonlat":"112.731,37.6642"},{"commCode":"TY_589","commRank":"2","centerLonlat":"112.732,37.6644"}];
				// app.map.moveToDirect(params[0].centerLonlat,10);
				//app.featureModifyLayer.source.clear();
				moveToDirect(params[0].centerLonlat,16);
				source.clear();
				for (var i = 0; i < params.length; i++) {
					var lonlat = params[i].centerLonlat.split(",");
					var feature = new ol.Feature({
						geometry: new ol.geom.Point(lonlat)
					});
					feature.set("commCode", params[i].commCode);
					feature.set("centerLonlat", params[i].centerLonlat);
					feature.set("commRank", params[i].commRank);
					feature.set("featureIndex", String(i + 1));
					var style = new ol.style.Style({
						image: new ol.style.Icon({
							anchor: [15, 30],
							anchorXUnits: "pixels",
							anchorYUnits: "pixels",
							opacity: 1,
							src: "resource/image/location_comm.png"
						}),
						// image: new ol.style.Circle({
						//   radius: 5,
						//   fill: new ol.style.Fill({
						// 	color: "orange"
						//   })
						// }),
						text: new ol.style.Text({
							text: feature.get("commRank") || feature.get("commRank") || "",
							font: "12px bold",
							fill: new ol.style.Fill({
								color: "#FFFFFF"
							}),
							offsetX: 0,
							offsetY: -16
						})
					});
					feature.setStyle(style);
					//app.featureModifyLayer.source.addFeature(feature);
					source.addFeature(feature);
				}
				getZoomShow();
			}	
			
			// 视图定位
			function moveToDirect(coordinate, zoom){
				if((typeof coordinate) == "string"){
					coordinate = coordinate.split(",");
				}
				if (zoom != undefined) map.getView().setZoom(zoom);
				var lon = parseFloat(coordinate[0]);
				var lat = parseFloat(coordinate[1]);
			    var arr = [lon,lat];
			    map.getView().setCenter(arr);
			}
			
			// 获取缩放级别并展示
			function getZoomShow(){
				var zoom = map.getView().getZoom();
				$("#zoom_level").val(zoom);
			}
			
			//添加比例尺
			// 发现，4.6.5的版本比例尺数值不正确
			function AddScaleLint() {
				var scaleLineControl = new ol.control.ScaleLine({
					Units: 'metric',//单位有5种：degrees imperial us nautical metric
				});
				map.addControl(scaleLineControl);
			}

			moveToDirect(testCenter, 15)
		</script>
	</body>
</html>
